<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RMLAU Students Rank wise Results</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Poppins',sans-serif; background:linear-gradient(135deg,#0f1419 0%,#1a202c 50%,#2d3748 100%); color:#e5e7eb; min-height:100vh; display:flex; flex-direction:column;}
    .card { background:linear-gradient(145deg,#1f2937 0%,#374151 100%); border:1px solid #4a5568; border-radius:1rem; }
    .rank-1{background:linear-gradient(135deg,#4d3d0f 0%,#6e541b 100%)!important;color:#f6e05e!important;font-weight:700;border:2px solid #ffcc00;}
    .rank-2{background:linear-gradient(135deg,#3a3b45 0%,#52535f 100%)!important;color:#e2e8f0!important;font-weight:600;border:2px solid #c0c0c0;}
    .rank-3{background:linear-gradient(135deg,#4a3824 0%,#5c452e 100%)!important;color:#d69e2e!important;font-weight:600;border:2px solid #cd7f32;}
    .rank-column{color:#fbbf24;font-weight:600;}.rollno-column{color:#60a5fa;font-weight:500;}.name-column{color:#34d399;font-weight:500;}.marks-column{color:#f87171;font-weight:600;}.result-column{color:#38bdf8;}
    .loader{border-top-color:#3b82f6;animation:spin 1s linear infinite;} @keyframes spin{to{transform:rotate(360deg);}}
    /* Responsive table */
    .responsive-table{display:flex;flex-direction:column;}
    .responsive-table thead{display:none;}
    .responsive-table tbody{display:block;width:100%;}
    .responsive-table tr{display:flex;flex-direction:column;border-bottom:1px solid #374151;margin-bottom:1rem;padding:1rem;border-radius:0.5rem;}
    .responsive-table td{padding:0.5rem 0;display:flex;justify-content:space-between;align-items:center;}
    .responsive-table td::before{content:attr(data-label);font-weight:600;color:#9ca3af;margin-right:1rem;}
    @media(min-width:768px){.responsive-table{display:table;} .responsive-table thead{display:table-header-group;} .responsive-table tbody{display:table-row-group;} .responsive-table tr{display:table-row;margin:0;padding:0;} .responsive-table td{display:table-cell;padding:1rem;} .responsive-table td::before{content:none;}}
    /* Modal */
    .modal {display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);backdrop-filter:blur(5px);}
    .modal-content {background:#1f2937;margin:15% auto;padding:30px;border:1px solid #4a5568;border-radius:1rem;width:90%;max-width:500px;}
    .close {float:right;font-size:28px;font-weight:bold;cursor:pointer;color:#aaa;}
    .close:hover {color:white;}
    .share-btn{background:linear-gradient(135deg,#10b981 0%,#059669 100%);padding:0.75rem 1.5rem;border-radius:0.75rem;transition:0.3s;}
    .share-btn:hover{background:linear-gradient(135deg,#059669 0%,#047857 100%);transform:translateY(-2px);}
    .action-btn { background:linear-gradient(135deg,#5a67d8 0%,#434190 100%); padding:0.5rem 1rem; border-radius:0.5rem; transition:0.3s; }
    .action-btn:hover { transform:translateY(-2px); }
    /* New styles for the PCT column */
    .pct-column { color:#f87171; font-weight:600; }
    .pct-col-cell { display: none; }
    /* Initial overlay */
    #overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 50;
    }
    /* Creator name styling */
    .creator-name {
      text-align: center;
      margin-top: 0.5rem;
      font-size: 1.125rem;
      font-weight: 600;
      background: linear-gradient(to right, #f59e0b, #d97706, #92400e);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
    }
  </style>
</head>
<body>
  
  <div id="overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50">
    <h1 class="text-3xl md:text-5xl font-extrabold text-white mb-6 animate-bounce">Ready to see the results?</h1>
    <button id="seeResultBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full text-xl transition-transform duration-300 hover:scale-105">
      SEE RESULT
    </button>
  </div>
  
  <div id="mainContent" class="container mx-auto p-4 md:p-8 max-w-6xl flex-grow hidden">
    <header class="text-center mb-8">
      <p id="collegeName" class="text-gray-400 mt-2 text-md md:text-lg"></p>
      <h2 id="mainHeading" class="text-2xl md:text-3xl font-extrabold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent">Student Results</h2>
      <p id="creatorName" class="creator-name hidden"></p>
      <div class="mt-4 text-sm text-gray-400">
        <p>
          Made By <span class="text-green-400 font-bold">RvS</span> | Website Badhiya Lagi! Follow To Banta Hai |
          <a href="https://www.instagram.com/vaikartana_raj/" target="_blank" class="text-pink-400 hover:underline">Insta- @Vaikartana_Raj</a> |
          <a href="https://wa.me/919838225780?text=Hello%20RvS!" target="_blank" class="text-green-400 hover:underline">WhatsApp- 9838225780</a>
        </p>
      </div>
    </header>

    <div class="card p-4 mb-8 flex flex-col md:flex-row gap-4 items-center">
      <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto mb-4 md:mb-0">
        <a href="https://realsaanvi.github.io/rmlau/Courses/" 
   class="action-btn text-white text-center font-medium" 
   target="_blank">More Sem Results</a>

<a href="http://rmlau.mnopdf.com/" 
   class="action-btn text-white text-center font-medium" 
   target="_blank">RMLAU Papers pdf</a>

      </div>
      <div class="relative flex-grow w-full">
        <input type="text" id="searchInput" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 px-5 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg" placeholder="Search by Roll No or Name...">
      </div>
      <div id="summary" class="flex gap-6 text-sm md:text-base text-gray-300"></div>
      <button id="shareBtn" class="share-btn text-white font-medium">Share Results</button>
    </div>

    <div id="loader" class="flex justify-center items-center h-64">
      <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-600 h-12 w-12"></div>
    </div>

    <div id="resultsContainer" class="card overflow-hidden hidden">
      <div class="overflow-x-auto">
        <table class="responsive-table w-full text-sm text-left">
          <thead class="bg-gray-800 text-gray-300 uppercase">
            <tr>
              <th class="px-6 py-4 rank-column">Rank</th>
              <th class="px-6 py-4 rollno-column">Roll No</th>
              <th class="px-6 py-4 name-column">Name</th>
              <th class="px-6 py-4 marks-column pct-column">PCT</th>
              <th class="px-6 py-4 marks-column">Marks</th>
              <th class="px-6 py-4 result-column">Result</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </div>

    <p id="noResults" class="text-center text-gray-500 mt-8 hidden">No results found.</p>
  </div>

  <footer class="text-center p-4 text-xs text-gray-600 mt-auto">
    <p>Disclaimer: Student project. Data fetched from Firebase. For official results visit university site.</p>
  </footer>

  <div id="shareModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 class="text-xl font-bold mb-4">Share Results</h2>
      <div class="mb-4">
        <label for="creatorNameInput" class="block text-sm font-medium text-gray-300 mb-2">Your Name (Optional)</label>
        <input type="text" id="creatorNameInput" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your name">
      </div>
      <textarea id="shareMessage" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-4 text-white h-32 resize-none mb-4" readonly></textarea>
      <div class="flex gap-4">
        <button id="copyBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Copy</button>
        <button id="whatsappBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">WhatsApp</button>
      </div>
    </div>
  </div>
  
  <audio id="backgroundMusic" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAm5zfkAWm6Dq_DWBNcLv7kaBKlu7C66WU",
      authDomain: "rmlau-rank-wise-result.firebaseapp.com",
      projectId: "rmlau-rank-wise-result",
      storageBucket: "rmlau-rank-wise-result.firebasestorage.app",
      messagingSenderId: "1069341171195",
      appId: "1:1069341171195:web:5af12e9ada7b4dac90ff5e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function getQueryParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    const seeResultBtn = document.getElementById("seeResultBtn");
    const mainContent = document.getElementById("mainContent");
    const overlay = document.getElementById("overlay");
    const backgroundMusic = document.getElementById("backgroundMusic");
    const songs = [
      "https://audio.jukehost.co.uk/dSuI2JK4PrsfsTgPz9sBWWxRlxK6GyCx",
      "https://audio.jukehost.co.uk/MhPalWbnMBGv2eqcva77n2mrEqR3iyqH",
      "https://audio.jukehost.co.uk/1rc7tH757PFXa0FqNt2Bl6yGD0l584sJ",
      "https://audio.jukehost.co.uk/MYlsWd7K9eLSr3KeZTTfoxiQ6uLS6wmX"
    ];

    // Check for creator parameter and display creator name
    const creatorParam = getQueryParam("creator");
    const creatorNameEl = document.getElementById("creatorName");
    if (creatorParam) {
      creatorNameEl.textContent = `By ${decodeURIComponent(creatorParam)}`;
      creatorNameEl.classList.remove("hidden");
    }

    seeResultBtn.addEventListener("click", () => {
      // Show the main content first
      mainContent.classList.remove("hidden");
      
      // Get roll parameter to determine course
      const rollParam = getQueryParam("roll");
      let songToPlay;
      
      if (rollParam && rollParam.length >= 14) {
        const courseCode = rollParam.charAt(3);
        
        // Play special song for B.A. (course code '1')
        if (courseCode === '1') {
          songToPlay = "https://audio.jukehost.co.uk/Kk3zWxxUy1k1MA0iuxb3DYEAg6EjHV19";
        } else {
          // Play random song for other courses
          songToPlay = songs[Math.floor(Math.random() * songs.length)];
        }
      } else {
        // Default to random song if no valid roll parameter
        songToPlay = songs[Math.floor(Math.random() * songs.length)];
      }
      
      backgroundMusic.src = songToPlay;
      backgroundMusic.play().catch(error => {
        console.log("Audio playback failed:", error);
      });
      
      // Hide the overlay and then remove it completely from the page
      overlay.style.display = 'none';
      overlay.remove(); // This line ensures it's completely gone from the DOM
      
      // Load the results after the button is clicked
      loadResults();
    });

    async function loadResults() {
      const rollParam = getQueryParam("roll");
      const loader = document.getElementById("loader");
      const resultsContainer = document.getElementById("resultsContainer");
      const resultsBody = document.getElementById("resultsBody");
      const noResults = document.getElementById("noResults");
      const summaryDiv = document.getElementById("summary");
      const searchInput = document.getElementById("searchInput");
      const mainHeading = document.getElementById("mainHeading");
      const collegeNameEl = document.getElementById("collegeName");
      const pctColumnHeader = document.querySelector('.pct-column');

      if (!rollParam || rollParam.length < 14) {
        loader.classList.add("hidden");
        noResults.classList.remove("hidden");
        noResults.textContent = "Invalid roll number.";
        return;
      }

      const courseCode = rollParam.charAt(3);
      const semesterCode = rollParam.charAt(13);

      let courseTitle = "";
      switch (courseCode) {
        case '1':
          courseTitle = "BACHELOR OF ARTS (B.A.)";
          break;
        case '2':
          courseTitle = "BACHELOR OF COMMERCE (B.COM.)";
          break;
        case '4':
          courseTitle = "BACHELOR OF SCIENCE (B.SC.)";
          break;
        default:
          courseTitle = "";
      }

      let semesterTitle = "";
      switch (semesterCode) {
        case '1':
          semesterTitle = "1ST SEM";
          break;
        case '2':
          semesterTitle = "2ND SEM";
          break;
        case '3':
          semesterTitle = "3RD SEM";
          break;
        case '4':
          semesterTitle = "4TH SEM";
          break;
        case '5':
          semesterTitle = "5TH SEM";
          break;
        case '6':
          semesterTitle = "6TH SEM";
          break;
        default:
          semesterTitle = "";
      }
      
      if (courseTitle && semesterTitle) {
        mainHeading.textContent = `${courseTitle} ${semesterTitle} STUDENT RESULTS`;
      } else {
        mainHeading.textContent = "Student Results";
      }

      const collegeCode = rollParam.substring(6, 10);
      try {
        const collegeDocRef = doc(db, "colleges", collegeCode);
        const collegeDocSnap = await getDoc(collegeDocRef);
        if (collegeDocSnap.exists()) {
          const collegeData = collegeDocSnap.data();
          if (collegeData.name) {
            collegeNameEl.textContent = collegeData.name;
          }
        }
      } catch (err) {
        console.error("Error fetching college name:", err);
      }

      try {
        const colRef = collection(db, rollParam);
        const snapshot = await getDocs(colRef);
        
        let allResults = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          allResults.push(data);
        });

        const allHavePCT = allResults.every(s => s.PCT && s.PCT !== "N/A" && !isNaN(parseFloat(s.PCT)));
        let sortKey = 'Marks';
        
        if (allHavePCT) {
          sortKey = 'PCT';
          pctColumnHeader.classList.remove('hidden');
        } else {
          pctColumnHeader.classList.add('hidden');
        }
        
        allResults.sort((a, b) => {
            const valA = parseFloat(a[sortKey]) || 0;
            const valB = parseFloat(b[sortKey]) || 0;
            return valB - valA;
        });

        allResults = allResults.map((s, i) => ({...s, Rank: i + 1}));

        loader.classList.add("hidden");
        if (!allResults.length) {
          noResults.classList.remove("hidden");
          return;
        }

        function renderTable(data) {
          resultsBody.innerHTML = "";
          data.forEach(stu => {
            const row = document.createElement("tr");
            if (stu.Rank === 1) row.classList.add("rank-1");
            if (stu.Rank === 2) row.classList.add("rank-2");
            if (stu.Rank === 3) row.classList.add("rank-3");
            
            let pctCell = '';
            if (allHavePCT) {
              pctCell = `<td data-label="PCT" class="px-6 py-4">${stu.PCT}</td>`;
            }

            row.innerHTML = `
              <td data-label="Rank" class="px-6 py-4">${stu.Rank}</td>
              <td data-label="Roll No" class="px-6 py-4">${stu["Roll No"]}</td>
              <td data-label="Student Name" class="px-6 py-4">${stu["Student Name"]}</td>
              ${pctCell}
              <td data-label="Marks" class="px-6 py-4">${stu.Marks}</td>
              <td data-label="Result" class="px-6 py-4"><a href="${stu.URL}" target="_blank" class="text-blue-400 hover:underline">View</a></td>`;
            resultsBody.appendChild(row);
          });
        }

        renderTable(allResults);
        summaryDiv.innerHTML = `Total Students: ${allResults.length}`;
        resultsContainer.classList.remove("hidden");

        searchInput.addEventListener("input", e => {
          const val = e.target.value.toLowerCase();
          const filtered = allResults.filter(stu =>
            (stu["Student Name"] && stu["Student Name"].toLowerCase().includes(val)) ||
            (stu["Roll No"] && stu["Roll No"].includes(val))
          );
          renderTable(filtered);
        });

        const shareBtn = document.getElementById("shareBtn");
        const shareModal = document.getElementById("shareModal");
        const shareMessage = document.getElementById("shareMessage");
        const creatorNameInput = document.getElementById("creatorNameInput");
        const copyBtn = document.getElementById("copyBtn");
        const whatsappBtn = document.getElementById("whatsappBtn");
        const closeModal = document.querySelector(".close");

        function updateShareMessage() {
          const collegeName = collegeNameEl.textContent;
          const headingText = mainHeading.textContent;
          const currentUrl = new URL(window.location);
          
          // Get creator name from input
          const creatorName = creatorNameInput.value.trim();
          
          // Update URL with creator parameter if name is provided
          if (creatorName) {
            currentUrl.searchParams.set('creator', encodeURIComponent(creatorName));
          } else {
            currentUrl.searchParams.delete('creator');
          }
          
          const msg = `${collegeName}\n\n${headingText}, Rank wise Result Declared! Check here: ${currentUrl.href}`;
          shareMessage.value = msg;
        }

        shareBtn.addEventListener("click", () => {
          updateShareMessage();
          shareModal.style.display = "block";
        });

        // Update share message when creator name input changes
        creatorNameInput.addEventListener("input", updateShareMessage);

        closeModal.onclick = () => shareModal.style.display = "none";
        window.onclick = (e) => { if (e.target === shareModal) shareModal.style.display = "none"; };
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(shareMessage.value);
          copyBtn.textContent = "Copied!";
          setTimeout(() => copyBtn.textContent = "Copy", 2000);
        };
        whatsappBtn.onclick = () => {
          window.open(`https://wa.me/?text=${encodeURIComponent(shareMessage.value)}`, "_blank");
        };

      } catch (err) {
        console.error("Firebase fetch error:", err);
        loader.classList.add("hidden");
        noResults.textContent = "An error occurred while fetching data.";
        noResults.classList.remove("hidden");
      }
    }
  </script>
</body>
</html>